<%Option Explicit%>
<!-- #include virtual="/include/manage.asp" -->
<!-- #include virtual="/manage/checksecurity.asp" -->
<meta http-equiv="Content-Type" content="text/html; charset=big5">
<%
HasPermission("news")
	'有發生錯誤也不會停止
	'on error resume next	
	Dim objUpload,objUploadedFile,ErrDescription,columnname
	Dim FileName,FileTag,i
	'-----------initialize--------------------------------------
	Response.Write("資料處理中，請稍候••••")
	FileName = Array(null,null)
	FileTag = Array(null,null)	
	Set objUpload = Server.CreateObject("aspSmartUpload.SmartUpload")
	objUpload.CodePage = "big5"
	objUpload.Upload
	i = 0	
	'對每個檔案分別動作 
	For each objUploadedFile In objUpload.Files 
		'有上傳檔案才存檔
		FileTag(i) = objUploadedFile.Name
		if objUploadedFile.FileName <> "" and ErrDescription = "" then
			FileName(i) = GetSNFile(FileTag(i),"category",FileTag(i),3)&"."&objUploadedFile.FileExt
			'存檔動作，目錄路徑要設定你自己的網站位址下的目錄，此例為您的主網頁目錄下的upload目錄 
			objUploadedFile.SaveAs  ("/upload/" & FileName(i)) 
			if instr(1,replace(Err.Description,"'",""),"(Error 1120)",1) <> 0 then ErrDescription = "無法儲存檔案!!"
		else
			FileName(i) = ""
		end if
		i=i+1
	next 
	if ErrDescription = "" or isnull(ErrDescription) then
		Dim titleimg,cimg
		Dim casesn,USQL,sn
		Dim result'----Insert result flag
		Dim cname,oldtitleimg,oldcimg,deltitleimg,delcimg
		sn = filter_data_normal(objUpload.form("sn"))
		cname = filter_data_normal(objUpload.form("cname"))
		'是否刪除舊上傳圖檔
		deltitleimg = lcase(filter_data_normal(objUpload.form("deltitleimg")))
		delcimg = lcase(filter_data_normal(objUpload.form("delcimg")))
		'撈舊檔案資料
		oldtitleimg = GetStringByWhereString("category","titleimg","where sn="&sn)
		oldcimg = GetStringByWhereString("category","cimg","where sn="&sn)
		
		For i = 0 to UBound(FileName)
			Select Case FileTag(i)
				Case "titleimg" :
					if deltitleimg<>"yes" and FileName(i)="" then
						titleimg = oldtitleimg
					else
						titleimg = FileName(i)
					end if
				Case "cimg":
					if delcimg<>"yes" and FileName(i)="" then
						cimg = oldcimg
					else
						cimg = FileName(i)
					end if
			End Select
		Next	
		
		USQL = "Update category Set cname='"& cname &"',titleimg='"& titleimg &"',cimg='"& cimg &"'"
		USQL = USQL& " where sn="&sn 
		'Response.Write "USQL="&USQL&"<BR>"
		'Response.end
		CONN.execute(USQL)
		 
		If Err.Number <> 0 then
			result = "FAIL"
		Else
			result = "SUCCESS"
		End if 
	else
		result = ErrDescription
	End if
	'檔案存放實體路徑
	Dim FilePath
	FilePath = Server.MapPath("/upload")
		
	Select Case result
		Case "SUCCESS":
			if deltitleimg="yes" or oldtitleimg <> titleimg then delfile FilePath,oldtitleimg 
			if delcimg="yes" or oldcimg <> cimg then delfile FilePath,oldcimg 
			PopMessage "Replace","修改成功","admin.asp"
		Case "FAIL":
			DeletAllFile FileName 
			PopMessage "Back","修改失敗，請稍後再試",""
		Case Else:
			DeletAllFile FileName 
			PopMessage "Back","修改失敗，請稍後再試("& result &")",""
	End Select	
'結束SmartUpload作業 
Set objUpload = nothing
%>